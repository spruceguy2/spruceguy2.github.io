<!doctype html>
<html>
  <head>
    <link href="style.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <title>MetroBuild</title>
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init()</script>
  </head>
  <body>
    <h1>MetroBuild 0.6</h1>
    By SpruceGuy
    <div id="map"></div>
    <button class="line" id="cyan">C</button>
    <button class="line" id="magenta">M</button>
    <button class="line" id="yellow">Y</button>
    <button class="line" id="black">K</button>
    <a id="l" href="?mode=limited">Limited mode</a>
    You have $<span id="cash">20</span>.
    
    <script>
      
     
      var par = new URLSearchParams(location.search)
      var mode = 0
      if(par.get("mode")=="limited"){
        mode = 1
        $("#l").text("Sandbox mode")
        $("#l").attr("href", "?mode=sandbox")
      }else{
        mode = 0
      }
      var lcci, lcyi, lcmi, lcki
      var cash = 20
      var index = -1
      var cindex = -1
      var yindex = -1
      var mindex = -1
      var kindex = -1
      var map = L.map('map').setView([40.75, -73.98], 13);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
      var y = {name:"y", dname:"y", color:"#ffff00", tcolor:"#000000", stations:[], markers:[], coords:[], line:L.polyline([], {color: '#ffff00', weight:6}).addTo(map)}
      var c = {name:"c", dname:"c", color:"#00ffff", tcolor:"#000000", stations:[], markers:[], coords:[], line:L.polyline([], {color: '#00ffff', weight:6}).addTo(map)}
      var m = {name:"m", dname:"m", color:"#ff00ff", tcolor:"#ffffff", stations:[], markers:[], coords:[], line:L.polyline([], {color: '#ff00ff', weight:6}).addTo(map)}
      var k = {name:"k", dname:"k", color:"#000000", tcolor:"#ffffff", stations:[], markers:[], coords:[], line:L.polyline([], {color: '#000000', weight:6}).addTo(map)}
      var ctrain = y
      
      var stations = []
      var hdm = []
      var markers = []
      class Station{
        constructor(name,lat,lng){
          this.name=name
          this.lat=lat
          this.lng=lng
          //add later
        }
        
      }
      function f(x){
        return 0
      }
      map.on('click', function(e){
        
        var NAME = prompt("What do you want your station to be called? (say 'hotdog' to make a hot dog stand)")
        if(NAME=="hotdog"){
          if(mode==1 && cash<7.5){
            alert("You need ten bucks.")
            return
          }else if(mode==1){
            cash -= 10
            $("#cash").text(cash)
          }
         var icon = L.icon({
            iconUrl: 'hotdog.png',
            shadowUrl: 'hotdog.png',

            iconSize:     [38, 38], // size of the icon
            shadowSize:   [0, 0], // size of the shadow
            iconAnchor:   [r, r], // point of the icon which will correspond to marker's location
            shadowAnchor: [0, 0],  // the same for the shadow
            popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
          });   
        hdm.push(L.marker([e.latlng.lat, e.latlng.lng]).addTo(map))
        }
        if(mode==1 && cash<10){
          alert("You need ten bucks.")
          return
        }else if(mode==1){
          cash -= 10
          $("#cash").text(cash)
        }
        stations.push(new Station(NAME,e.latlng.lat,e.latlng.lng))
        markers.push(L.marker([e.latlng.lat, e.latlng.lng]).addTo(map))
        
        index++
        markers[index].bindPopup(NAME+`<button onclick="removeStation(${index})" class="remover">Remove station</button> <button onclick="addTrain('${ctrain.name}',${index})" class="adder">Add current train</button>`)
        
        for(let i of stations){
          if(Math.abs(e.latlng.lat - i.lat)<=0.01){
            markers[stations.indexOf(i)].openPopup()
          }
          if(Math.abs(e.latlng.lng - i.lng)<=0.01){
            markers[stations.indexOf(i)].openPopup()
          }
        }
        
        
        ctrain.markers.push(markers[index])
        ctrain.stations.push(stations[index])
        
        
        
        
        if(ctrain==c){
          markers[index].on('click', ()=>{lcci = Number(index)})
          cindex++
          ctrain.coords.splice(lcci+1, 0, [e.latlng.lat, e.latlng.lng])
        }
        if(ctrain==y){
          markers[index].on('click', ()=>{lcyi = Number(index)})
          yindex++
          ctrain.coords.splice(lcyi+1, 0, [e.latlng.lat, e.latlng.lng])
        }
        if(ctrain==m){
          markers[index].on('click', ()=>{lcmi = Number(index)})
          mindex++
          ctrain.coords.splice(lcmi+1, 0, [e.latlng.lat, e.latlng.lng])
        }
        if(ctrain==k){
          markers[index].on('click', ()=>{lcki = Number(index)})
          kindex++
          ctrain.coords.splice(lcki+1, 0, [e.latlng.lat, e.latlng.lng])
        }
        ctrain.line.setLatLngs(ctrain.coords)
      })
      $("#cyan").click(function(){
        switch(ctrain.name){
          case "y":
            y = ctrain
            break
          case "m":
            m = ctrain
            break
          case "k":
            k = ctrain
            break
            
        }
        ctrain = c
        
        console.log(ctrain)
      })
      $("#yellow").click(function(){
        switch(ctrain.name){
          case "c":
            c = ctrain
            break
          case "m":
            m = ctrain
            break
          case "k":
            k = ctrain
            break
          
            
        }
        ctrain = y
        
      })
      $("#magenta").click(function(){
        switch(ctrain.name){
          case "y":
            y = ctrain
            break
          case "c":
            c = ctrain
            break
          case "k":
            k = ctrain
            break
            
        }
        ctrain = m
        
        console.log(ctrain)
      })
      $("#black").click(function(){
        switch(ctrain.name){
          case "c":
            c = ctrain
            break
          case "m":
            m = ctrain
            break
          case "y":
            y = ctrain
            break
          
            
        }
        ctrain = k
        
      })
      function removeStation(K){
        if(mode==1){
          cash += 9
          $("#cash").text(cash)
        }
        var ind = 0
        if(ctrain.name=="c"){
          ind=cindex
        }
        if(ctrain.name=="y"){
          ind=yindex
        }
        if(ctrain.name=="m"){
          ind=mindex
        }
        if(ctrain.name=="k"){
          ind=kindex
        }
        
var trainIndex = ctrain.markers.indexOf(markers[K])
        if(trainIndex !== -1){
          ctrain.coords.splice(trainIndex, 1)
          ctrain.markers.splice(trainIndex, 1)
          ctrain.stations.splice(trainIndex, 1)
          if(ctrain.name=="c"){
            cindex--
          }
    
          if(ctrain.name=="y"){
            yindex--
          }
          if(ctrain.name=="m"){
            mindex--
          }
    
          if(ctrain.name=="k"){
            kindex--
          }
        }
        markers[K].remove() // bug here
        markers.splice(K, 1)
        stations.splice(K, 1)
        index--
        clean()
        
      }
      function addTrain(l,dex){
          var line
          switch(l){
            case "y":
              line = y
              break
            case "c":
              line = c
              break
            case "m":
              line = m
              break
            case "k":
              line = k
              break
          }
          var trainIndex = line.markers.indexOf(markers[dex])
          ctrain.markers.push(markers[dex])
          ctrain.stations.push(line.stations[trainIndex])
          ctrain.coords.push([line.stations[trainIndex].lat, line.stations[trainIndex].lng])
          clean()
      }
      function clean(){
        ctrain.line.removeFrom(map)
        ctrain.line.setLatLngs([])
        
        for(let j of ctrain.coords){
          if(j!==37){
            ctrain.line.addLatLng(new L.LatLng(j[0],j[1])) // bug here
          }
        }
        ctrain.line.addTo(map)
      }
      setInterval(function(){
        clean()
        var inc = Math.floor(4*(stations.length+Math.random()-0.5))/16
        if(-inc > cash){
          cash = 0
          return
        }
        cash += inc
        $("#cash").text(cash)
      },500)
    </script>
  </body>
</html>
